## Building

The program uses the following libraries:
* assimp
* tbb (needed only for multithreading)
* Googletest (only for testing)
* Googlemock (only for testing)

The program can be compiled with command `make` in `src/` directory.
To include the multithreading support, compile the program with
`make enable_parallel=1`

## Testing

Tests can be run with the command `make test` and the code coverage report
can be generated with the command `make coverage`. Note that some of
the performance tests fail when running `make coverage` because the
compiler optimizations are not used.

## Performance report

Performance report can be generated with the command `make performance`.

## Usage

The program can be run running the following
commands in the `src/` directory: `./bin/main PATH_TO_INPUT` or
`PATH_TO_MAIN PATH_TO_INPUT --verbose` which will also print some extra
information (currently only about the input parsing process).

As output, the program will generate some number of images as
defined in the input file.

For geometry calculations the program uses the epsilon value of 1e-10.
If the models contain very small triangles, this might cause
the program to detect these as degenerate triangles which will
cause the program to terminate.

### Normals
For ray reflections, shading etc the program uses the
vertex normals provided in the input file or generated by
the importing library. The surface normals are then interpolated
from these. This is needed for "smooth" shading.
However, the ray/triangle intersections are still
done with the raw triangles. This means that there will still be some
cases where the color transitions between triangles are not smooth:

```
l   :
 .  :
  . :
   .:
    /\
   /  \
  /    \

```
(The colons mark the vertex normal)
Here the light can never illuminate the right side of the object.
However, the very top end of the left side is still quite
intensely illumintated leading to a high contrast between the sides.


## Input format

The used file format consists of sections `camera`, `model`, `point_light`,
`environment_light`, `render` and `image`. Sections
start with a line consisting of only the section name.

Every
section has some fields. Fields are simply lines starting
with the name of the fields. For every section there can be
at most one field with any given field name.
Fields can have default values
which are used if no explicit values are provided.

If sections `camera`, `environment_light` or  `render` have not been
specified, then ones with default parameters will be generated by the parser.

Lines starting with `//` as well as lines containing only
whitespaces will be ignored.

### `camera`
At most one per file. Defines the camera used for rendering.

Fields are:

* `pos x y z`:
  * `x`, `y` and `z` are numbers.
  * The position of the camera.
* `front x y z`:
  * `x`, `y` and `z` are numbers. `norm(x, y, z) > 0`
  * The vector defining the front direction of the camera. The middle
    point of the image plane is at `pos + front`. Only things in the
    front of the image plane will be rendered.
* `up x y z`:
  * `x`, `y` and `z` are numbers. `norm(x, y, z) > 0`. Should be perpendicular to `front`
  * The vector defining the up direction of the camera.
* `x_fov x`:
  * `0 < x < 180`
  * The x-axis field of view in degrees.
* `y_fov y`:
  * `0 < y < 180`
  * The y-axis field of view in degrees.

Default values are:
```
pos 0.0 0.0 0.0
front 0.0 0.0 -1.0
up 0.0 1.0 0.0
x_fov 90
y_fov 90
```

### `model`
Any number of these can be in one file.

Fields are:

* `file x`:
  * `x` is a string without whitespaces.
  * The relative path to the loaded model. See section Model format
      for more information. **Required** field.
* `pos x y z`:
  * `x`, `y` and `z` are numbers.
  * The position of the model.
* `normal t`:
  * `t` is either `smooth` or `rough`
  * **Ignored if the model has defined normals.**
  * The type of generated normals.

Default values are:
```
pos 0.0 0.0 0.0
normal rough
```

### `point_light`
Any number of these can be in one file.

Fields are:

* `pos x y z`:
  * `x`, `y` and `z` are numbers.
  * The position of the point light.
* `color r g b`:
  * `r, g, b >= 0`
  * Color of the light.

Default values are:
```
pos 0.0 0.0 0.0
color 1.0 1.0 1.0

```
### `environment_light`
At most one per file. Defines the environmen light i.e. the light
that is "seen" by the rays that don't hit any objects. If the type
of the light is set to `uniform`, then the color will be the same
no matter the direction of the ray. If the type is set to `directed`
then the brightness is `color * max(0.0, cos(alpha))^exp` where
`alpha` is the angle between the ray and `direction` of the environment
light.

Fields are:

* `color r g b`:
  * `r, g, b >= 0`
  * Color of the environment light
* `type t`:
  * `t` is either `uniform` or `directed`
* `direction x y z`
  * **Ignored if `type uniform` has been set**
  * `x`, `y` and `z` are numbers. `norm(x, y, z) > 0`
  * Direction from which the light rays are coming the most intensely
* `exp e`:
  * **Ignored if `type uniform` has been set**
  * `e > 0`
  * Defines the directinality of the light.

Default values are:
```
color 0.0 0.0 0.0
type uniform
direction 0.0 1.0 0.0
exp 1.0
```
### `render`
At most one per file. Parameters for the renderer.

Fields are:
* `width px`:
  * `px` is an integer. `px > 0`
  * Width of the rendered image in pixels.
* `height px`:
  * `px` is an integer. `px > 0`
  * Height of the rendered image in pixels
* `pixel_rays r`:
  * `r` is an integer. `r > 0`
  * Number of rays per pixel. If `r == 1` then the ray will be shot
    to the middle of the pixel. Otherwise `r` rays will be sampled
    randomly from a uniform distribution inside the pixel.
* `depth d`:
  * `d` is an integer. `d > 0`
  * Maximum recursion depth for the raytracing.
* `branching b`
  * `b` is an integer. `b > 0`
  * The number of rays that a ray is split into every time
    it hits something.

Default values are:
```
width 500
height 500
pixel_rays 1
depth 1
branching 1
```

### `image`
Any number can be present in a file.
Parameters for saving the results of `render`. The image
will be saved to `PATH_TO_INPUT/f` where f is the value
of the `file` field. The operations are
applied to the image in the order: truncate, scale, save.

Fields are:
* `file f`:
  * **Required field**
  * `f` is a string without whitespaces.
  * Filename of the saved image.
* `truncate f`
  * `0.0 < f <= 1.0`
  * Truncate pixel color values to the value of `f * n_values`th least
    bright pixel where `n_values = n_pixels * 3`. Used to prevent
    the very brightest pixels from dimming down the image.
* `scale_max x`:
  * `x > 0`. **Probably you want `x <= 1`**
  * Value to which the brightest value in the image is scaled to.
    At saving, values above 1 will not be displayed correctly.

Default values are:
```
truncate 1.0
scale_max 1.0
```

## Model format
The program uses the Assimp library to load the models. Many different
formats might work but the program has been only tested with
Wavefront .obj and accompanying .mtl files.
(see https://en.wikipedia.org/wiki/Wavefront_.obj_file )

Currently the program supports the following material properties:
* `Ka`: This is interpreted as emission. The material will look like
   a perpendicular light with radiance `Ka` is always shone to it and
   the material is perfectly diffuse. **Note that this means that
   the object will look equally bright from every direction but
   will illuminate other objects the most to the normal direction.**
* `Kd`: The diffuse color.
* `Ks` and `Ns`. The specular color and exponent. Used as in the
  original Phong model. High specular exponents (>1 000 000 000) can be used
  to mimic a material with perfect reflections/refractions (i.e. mirror).
  Very high specular exponents (like 1e20) seem to cause quite a lot
  artefacts.
* `d` and `Kt`. The transparency will be `(1.0 - d) * Kt`.
* `Ni` is the optical density of the side to which the triangle normal
   doesn't point to. Optical density of the other side is always
   assumed to be 1.

No guarantees about the default values of these should be assumed.
